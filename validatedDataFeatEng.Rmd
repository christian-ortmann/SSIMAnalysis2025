---
title: "validatedDataFeatEng"
output: html_document
date: "2025-01-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) #for all chunks, we dont want to see code in markdown output

```



```{r imports, warning = FALSE, message = FALSE}

if (!require("pacman")) 
  install.packages("pacman")

pacman::p_load(
  here, #import data
  tidyverse, #ggplot, dplyr, readr etc.
  remotes, #to install a github package for time integration
  envalysis, #for publication ready plots
  patchwork
  
)

remotes::install_github("pnnl/Smisc") #for time integration of solar irradiance to calculate solar radiation

```


```{r read data}
#add in the above {r = read data} echo=FALSE if we want to hide the code that generates a plot (though there are no plots in this chunk, just an aside...)

m8cont <- readRDS(here("mine8FinalDataValidated.rds")) 
head(m8cont)


```


```{r generate features}

#------------------------
#KW/H #integrate irradiance over time
#------------------------


m8cont$irradiance[m8cont$irradiance == 0] <- 1e-10  # Replace zeros with a small value, fix for the timeIntegration function

# Create a vector to store results
solar_insolation <- numeric(length(m8cont$datetime))

# Loop through each timestamp
for (i in seq_along(m8cont$datetime)) {
  # Define the current timestamp
  current_time <- m8cont$datetime[i]
  
  # Filter data for the last 24 hours
  subset_data <- m8cont[m8cont$datetime >= (current_time - 24*3600) & #find the current time from 24 hours earlier
                        m8cont$datetime <= current_time, ]
  
  # Perform time integration if there is enough data
  if (nrow(subset_data) > 1) {
    solar_insolation[i] <- Smisc::timeIntegration(
      data = subset_data$irradiance,
      time = subset_data$datetime,
      upper = max(subset_data$datetime),
      lower = min(subset_data$datetime),
      check.plot = FALSE # Disable plots for efficiency
    )
  } else {
    # If not enough data, set to NA
    solar_insolation[i] <- 0
  }
}

# wh/m^2 convert to kWh m/^2

m8cont$solarInsol24 <- solar_insolation


#------------------------
#solar insolation plot
#------------------------

#insolation
i8 <- ggplot(m8cont) + 
  geom_line(aes(as.POSIXct(datetime), solarInsol24), color = 'brown3') + 
  labs(x = '',
       y = bquote('Solar Insolation ' (kWh/m^2)), 
       title = 'Solar Insolation') + 
  scale_y_continuous(expand = c(0, 0))+ 
  scale_x_datetime(expand = c(0, 0)) +
  theme_publish()
i8

ggsave(file = here("figures/m8insolation.svg"), plot = i8, height = 5, width = 7)

#------------------------
#rolling sums of rain
#------------------------
m8cont <- m8cont |> 
  mutate(
    'sumrain24'= rollapply(rainmm, width = 24, FUN = sum, fill = 0, align = 'left', partial = TRUE), 
    'sumrain6'= rollapply(rainmm, width = 6, FUN = sum, fill = 0, align = 'left', partial = TRUE)
    )

m8cont <- m8cont |>
  mutate(datetime = as.integer(datetime))

```

```{r standardize data for lasso logit}

noTime <- subset(m8cont, select = -c(datetime, rockfall))

m8contStd <- as.data.frame(scale(noTime, center=TRUE, scale=TRUE)) #standardize data

#add standardize data back
m8contStd$datetime <- m8cont$datetime
m8contStd$rockfall <- m8cont$rockfall


```

```{r save dataset}

saveRDS(m8cont, here("mine8DataForML.rds"))

saveRDS(m8contStd, here("mine8StandardizedDataForML.rds"))


```



``` {r creating all weather plot data}



# Create daily count and unique hour count
rockfallsDailyCount <- M8Rockfalls |>
  mutate(rockfall = 1, 
         date = as_date(datetime), 
         hour = hour(datetime)) |>
  group_by(date) |>
  summarize(
    rockfall = sum(rockfall),  # Total rockfalls per day
    unique_hours = n_distinct(hour),  # Count of unique hours with rockfalls
    avg_time = mean(datetime)  # Average timestamp for plotting
  ) |>
  mutate(cumuRockfall = cumsum(rockfall))

# Plot daily rockfall with unique hour count
RF8 <- ggplot(rockfallsDailyCount, aes(x = as.POSIXct(avg_time))) + 
  geom_point(aes(y = rockfall, color = "Discrete Rockfalls")) +
  geom_line(aes(y = rockfall, color = "Discrete Rockfalls")) +
  geom_point(aes(y = unique_hours, color = "Rockfall Hours")) +
  geom_line(aes(y = unique_hours, color = "Rockfall Hours")) +
  labs(title = 'Daily Rockfall Events and Hours of Initiation', 
       y = 'Discrete Count',
       color = "Legend") +  # Legend title
  scale_y_continuous(
    limits = c(0, 40), 
    sec.axis = sec_axis(~ . * (24 / 40), name = "Hours with Rockfall")  # Rescale to max 24 hours
  ) +   
  scale_x_datetime(expand = c(0, 0)) +
  scale_color_manual(values = c("Discrete Rockfalls" = "red", "Rockfall Hours" = "blue")) +  # Custom colors
  theme_bw() + 
  theme(
    axis.title.x = element_blank(), 
    axis.text.y = element_text(size = 14), 
    axis.title.y = element_text(size = 14), 
    axis.text.x = element_text(size = 14), 
    plot.title = element_text(size = 14),
    legend.position = "bottom",
    legend.title = element_blank()
  )

RF8


ggsave(here("figures/mine8RockfallValidatedTimeSeries.png"), plot=RF8, width=7, height=5)





#-----------------------
m8cont$datetime <- as.POSIXct(m8cont$datetime, format = "%Y-%m-%d %H:%M:%S", tz = "UTC")
max_irradiance <- max(m8cont$irradiance, na.rm = TRUE)
max_solarInsol <- max(m8cont$solarInsol24, na.rm = TRUE)


max_rainmm <- max(m8cont$rainmm, na.rm = TRUE)
max_intensity <- max(m8cont$intensity, na.rm = TRUE)

#temperature
weatherplot8TempC <- ggplot(m8cont) + 
  geom_line(aes(datetime, tempC, color = 'Temperature 1hr'), alpha = 0.2) + 
  geom_line(aes(datetime,na.locf(rollapply(tempC, width = 24, FUN = mean, fill = NA, align = 'right', partial = TRUE)), color = "Temperature 24hr")) + 
  labs(x = '',
       y = 'Temperature (\u00B0C)', 
       title = 'Temperature') + 
  scale_y_continuous(expand = c(0, 0)) +  # Blank secondary y-axis 
  scale_x_datetime(expand = c(0, 0)) +
  scale_color_manual(values = c("Temperature 1hr" = "red", 
                                "Temperature 24hr" = "red")) +
  theme_publish() + 
theme(legend.position = c(0.5, -0.25),  # Position legend at the bottom
      legend.direction = "horizontal", 
          legend.title = element_blank(),
          axis.title.x = element_blank(), 
          axis.title.y = element_text(size = 11),
          axis.text.x = element_text(size = 10, angle = 40, vjust = 0.5)
    )

t8 <- weatherplot8TempC
t8

#add rockfall
#-------------------------------------
# Define scaling factors
max_temp <- max(m8cont$tempC, na.rm = TRUE)  # Max temperature
max_rockfalls <- 40  # Set max rockfall count to 40

# Create the combined plot
t8_combined <- ggplot(m8cont, aes(x = datetime)) + 
  # Temperature plot
  # geom_line(aes(y = tempC, color = "Temperature 1hr"), alpha = 0.2) + 
  geom_line(aes(y = na.locf(rollapply(tempC, width = 24, FUN = mean, fill = NA, align = 'right', partial = TRUE)), color = "Temperature 24hr")) + 
  # Rockfall data scaled to match temperature range
  geom_area(data = rockfallsDailyCount, aes(x = as.POSIXct(avg_time), y = rockfall * (max_temp / max_rockfalls),color = "Discrete Rockfalls"), alpha = 0.5, fill = "lightgray") +
  # Axis labels and limits
  labs(x = '', 
       y = 'Temperature (\u00B0C)', 
       title = 'Temperature', 
       color = "Legend") + 
  scale_y_continuous(limits = c(0, max_temp),  # Fix temperature axis limits
                     sec.axis = sec_axis(~ . * (max_rockfalls / max_temp), name = "Rockfall Count", breaks = seq(0, 40, 10)), expand = expansion(mult = c(0, 0.05))) + 
  scale_x_datetime(expand = c(-0.005, 0)) +
  scale_color_manual(values = c(
    # "Temperature 1hr" = "red", 
                                
    "Temperature 24hr" = "red", 
                               
     "Discrete Rockfalls" = "lightgray")) +
  theme_publish() + 
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10, angle = 40, vjust = 0.5))

# Display the updated plot
t8_combined


#--------------------------


#precipitation
weatherplot8Precip <- ggplot(m8cont) + 
  geom_line(aes(datetime, rainmm, color = 'Rainfall 1hr')) + 
  geom_line(aes(datetime, scales::rescale(intensity, to = c(0, max_rainmm)), color = "Rainfall Intensity")) + 
  labs(x = '',
       y = 'Precipitation (mm)',
       title = 'Precipitation') + 
  scale_color_manual(values = c("Rainfall 1hr" = "blue", 
                                "Rainfall Intensity" = "orange")) +
  scale_y_continuous(expand = c(0, 0), sec.axis = sec_axis(~ . * (max_intensity / max_rainmm), name = "Rainfall Intensity (mm/hr)")) + 
  scale_x_datetime(expand = c(0, 0)) +
  theme_publish() +
theme(legend.position = c(0.5, -0.25),  # Position legend at the bottom
      legend.direction = "horizontal", 
          legend.title = element_blank(),
          axis.title.x = element_blank(), 
          axis.title.y = element_text(size = 11),
          axis.text.x = element_text(size = 10, angle = 40, vjust = 0.5)
    )



p8 <- weatherplot8Precip
p8



#add rockfall for precip intensity
#-------------------------------------
# Define scaling factors
max_inten <- max(m8cont$intensity, na.rm = TRUE)  # Max temperature
max_rockfalls <- 40  # Set max rockfall count to 40

# Create the combined plot
pi8_combined <- ggplot(m8cont, aes(x = datetime)) + 
  # Temperature plot
  geom_line(aes(y = intensity, color = "Precipitation Intensity")) + 
  # Rockfall data scaled to match temperature range
  geom_area(data = rockfallsDailyCount, aes(x = as.POSIXct(avg_time), y = rockfall * (max_inten / max_rockfalls),color = "Discrete Rockfalls"), alpha = 0.5, fill = "lightgray") +
  # Axis labels and limits
  labs(x = '', 
       y = 'Precipitaion Intensity (mm/hr)', 
       title = 'Precipitation Intensity', 
       color = "Legend") + 
  scale_y_continuous(limits = c(0, max_inten),  # Fix temperature axis limits
                     sec.axis = sec_axis(~ . * (max_rockfalls / max_inten), name = "Rockfall Count", breaks = seq(0, 40, 10)), expand = expansion(mult = c(0, 0.05))) + 
  scale_x_datetime(expand = c(-0.005, 0)) +
  scale_color_manual(values = c(
    "Precipitation Intensity" = "blue", 
                                
    # "Temperature 24hr" = "red", 
                               
     "Discrete Rockfalls" = "lightgray")) +
  theme_publish() + 
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10, angle = 40, vjust = 0.5))

# Display the updated plot
pi8_combined


#--------------------------



#add rockfall for precip 
#-------------------------------------
# Define scaling factors
max_precip <- max(m8cont$rainmm, na.rm = TRUE)  # Max temperature
max_rockfalls <- 40  # Set max rockfall count to 40

# Create the combined plot
p8_combined <- ggplot(m8cont, aes(x = datetime)) + 
  # Temperature plot
  geom_line(aes(y = rainmm, color = "Precipitation 1hr")) + 
  # Rockfall data scaled to match temperature range
  geom_area(data = rockfallsDailyCount, aes(x = as.POSIXct(avg_time), y = rockfall * (max_precip / max_rockfalls),color = "Discrete Rockfalls"), alpha = 0.5, fill = "lightgray") +
  # Axis labels and limits
  labs(x = '', 
       y = 'Precipitation (mm)', 
       title = 'Precipitation', 
       color = "Legend") + 
  scale_y_continuous(limits = c(0, max_precip),  # Fix temperature axis limits
                     sec.axis = sec_axis(~ . * (max_rockfalls / max_precip), name = "Rockfall Count", breaks = seq(0, 40, 10)), expand = expansion(mult = c(0, 0.05))) + 
  scale_x_datetime(expand = c(-0.005, 0)) +
  scale_color_manual(values = c(
    "Precipitation 1hr" = "skyblue", 
                                
    # "Temperature 24hr" = "red", 
                               
     "Discrete Rockfalls" = "lightgray")) +
  theme_publish() + 
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10, angle = 40, vjust = 0.5))

# Display the updated plot
p8_combined


#--------------------------


#irradiance
weatherplot8Irr <- ggplot(m8cont) + 
  geom_line(aes(datetime, irradiance, color = 'Irradiance 1hr'), alpha = 0.2) +
  geom_line(aes(datetime, na.locf(rollapply(irradiance, width = 24, FUN = mean, fill = NA, align = 'right', partial = TRUE)), color = "Irradiance 24hr")) + 
  geom_line(aes(datetime, scales::rescale(solarInsol24, to = c(0, max_irradiance)), color = 'Solar Insolation 24hr')) + 
  labs(x = '',
       y = bquote('Irradiance' (W/m^2)), 
       title = 'Solar Irradiance') + 
  scale_y_continuous(expand = c(0, 0), sec.axis = sec_axis(~ . * (max_solarInsol / max_irradiance), name = bquote('Solar Insolation' ~ (kWh/m^2)))) + 
  scale_x_datetime(expand = c(0, 0)) +
  scale_color_manual(values = c("Irradiance 1hr" = "yellow4", 
                                "Irradiance 24hr" = "yellow4",
                                "Solar Insolation 24hr" = "purple")) +
  theme_publish() + 
theme(legend.position = c(0.5, -0.25),  # Position legend at the bottom
      legend.direction = "horizontal", 
          legend.title = element_blank(),
          axis.title.x = element_blank(), 
          axis.title.y = element_text(size = 11),
          axis.text.x = element_text(size = 10, angle = 40, vjust = 0.5)
    )


i8 <- weatherplot8Irr
i8


#add rockfall for irradiance
#-------------------------------------
# Define scaling factors
max_irr <- max(na.locf(rollapply(m8cont$irradiance, width = 24, FUN = mean, fill = NA, align = 'right', partial = TRUE)))  # Max temperature
max_rockfalls <- 40  # Set max rockfall count to 40

# Create the combined plot
irr8_combined <- ggplot(m8cont, aes(x = datetime)) + 
  # Temperature plot
  geom_line(aes(datetime, na.locf(rollapply(irradiance, width = 24, FUN = mean, fill = NA, align = 'right', partial = TRUE)), color = "Irradiance 24hr")) + 
  # Rockfall data scaled to match temperature range
  geom_area(data = rockfallsDailyCount, aes(x = as.POSIXct(avg_time), y = rockfall * (max_irr / max_rockfalls),color = "Discrete Rockfalls"), alpha = 0.5, fill = "lightgray") +
  # Axis labels and limits
  labs(x = '', 
       y = bquote('Irradiance' (kW/m^2)), 
       title = 'Solar Irradiance',
       color = "Legend") + 
  scale_y_continuous(limits = c(0, max_irr),  # Fix temperature axis limits
                     sec.axis = sec_axis(~ . * (max_rockfalls / max_irr), name = "Rockfall Count", breaks = seq(0, 40, 10)), expand = expansion(mult = c(0, 0.05))) + 
  scale_x_datetime(expand = c(-0.005, 0)) +
  scale_color_manual(values = c(
    "Irradiance 24hr" = "yellow4", 
                                
    # "Temperature 24hr" = "red", 
                               
     "Discrete Rockfalls" = "lightgray")) +
  theme_publish() + 
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10, angle = 40, vjust = 0.5))

# Display the updated plot
irr8_combined


#--------------------------



#add rockfall for solar insolation
#-------------------------------------
# Define scaling factors
max_insol <- max(m8cont$solarInsol24, na.rm = TRUE)  # Max temperature
max_rockfalls <- 40  # Set max rockfall count to 40

# Create the combined plot
insol8_combined <- ggplot(m8cont, aes(x = datetime)) + 
  # Temperature plot
  geom_line(aes(datetime,solarInsol24, color = 'Solar Insolation 24hr')) +
  # geom_line(aes(datetime, na.locf(rollapply(irradiance, width = 24, FUN = mean, fill = NA, align = 'right', partial = TRUE)), color = "Irradiance 24hr")) + 
  # Rockfall data scaled to match temperature range
  geom_area(data = rockfallsDailyCount, aes(x = as.POSIXct(avg_time), y = rockfall * (max_insol / max_rockfalls),color = "Discrete Rockfalls"), alpha = 0.5, fill = "lightgray") +
  # Axis labels and limits
  labs(x = '', 
       y = bquote('Solar Insolation' ~ (kWh/m^2)), 
       title = 'Solar Insolation',
       color = "Legend") + 
  scale_y_continuous(limits = c(0, max_insol),  # Fix temperature axis limits
                     sec.axis = sec_axis(~ . * (max_rockfalls / max_insol), name = "Rockfall Count", breaks = seq(0, 40, 10)), expand = expansion(mult = c(0, 0.05))) + 
  scale_x_datetime(expand = c(-0.005, 0)) +
  scale_color_manual(values = c(
    "Solar Insolation 24hr" = "purple", 
                                
    # "Temperature 24hr" = "red", 
                               
     "Discrete Rockfalls" = "lightgray")) +
  theme_publish() + 
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10, angle = 40, vjust = 0.5))

# Display the updated plot
insol8_combined


#--------------------------




#wind
weatherplot8Wind <- ggplot(m8cont) + 
  geom_line(aes(datetime, windMS, color = 'Wind 1hr'), alpha = 0.2) + 
  geom_line(aes(datetime,na.locf(rollapply(windMS, width = 24, FUN = mean, fill = NA, align = 'right', partial = TRUE)), color = "Wind 24hr")) +
  labs(
    title = " Wind",
    x = "", 
    y = "Wind (m/s)"
  ) + 
  scale_y_continuous(expand = c(0, 0)) +  # Blank secondary y-axis 
  scale_x_datetime(expand = c(0, 0)) +
     scale_color_manual(values = c("Wind 1hr" = "darkgreen", 
                                "Wind 24hr" = "darkgreen")) +
  theme_publish() + 
theme(legend.position = c(0.5, -0.25),  # Position legend at the bottom
      legend.direction = "horizontal", 
          legend.title = element_blank(),
          axis.title.x = element_blank(), 
          axis.title.y = element_text(size = 11),
          axis.text.x = element_text(size = 10, angle = 40, vjust = 0.5)
    )






w8 <- weatherplot8Wind
w8


#add rockfall for wind
#-------------------------------------
# Define scaling factors
max_wind <- max(na.locf(rollapply(m8cont$windMS, width = 24, FUN = mean, fill = NA, align = 'right', partial = TRUE)))  # Max temperature
max_rockfalls <- 40  # Set max rockfall count to 40

# Create the combined plot
wind8_combined <- ggplot(m8cont, aes(x = datetime)) + 
  # Temperature plot
  # geom_line(aes(datetime,windMS, color = 'Wind 1hr')) +
  geom_line(aes(datetime,na.locf(rollapply(windMS, width = 24, FUN = mean, fill = NA, align = 'right', partial = TRUE)),  color = 'Wind 24hr')) +
  # Rockfall data scaled to match temperature range
  geom_area(data = rockfallsDailyCount, aes(x = as.POSIXct(avg_time), y = rockfall * (max_wind / max_rockfalls),color = "Discrete Rockfalls"), alpha = 0.5, fill = "lightgray") +
  # Axis labels and limits
  labs(x = '', 
       y = 'Wind (m/s)', 
       title = 'Wind',
       color = "Legend") + 
  scale_y_continuous(limits = c(0, max_wind),  # Fix temperature axis limits
                     sec.axis = sec_axis(~ . * (max_rockfalls / max_wind), name = "Rockfall Count", breaks = seq(0, 40, 10)), 
                     expand = expansion(mult = c(0, 0.05))) +  # Fix rockfall axis 0-40
  scale_x_datetime(expand = c(-0.005, 0)) +
  scale_color_manual(values = c(
    "Wind 24hr" = "darkgreen", 
                                
    # "Temperature 24hr" = "red", 
                               
     "Discrete Rockfalls" = "lightgray")) +
  theme_publish() + 
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10, angle = 40, vjust = 0.5))

# Display the updated plot
wind8_combined


#--------------------------






ggsave(file = here("figures/m8temp.svg"), plot = t8, height = 5, width = 7)
ggsave(file = here("figures/m8precipitation.svg"), plot = p8, height = 5, width = 7)
ggsave(file = here("figures/m8irradiance.svg"), plot = i8, height = 5, width = 7)
ggsave(file = here("figures/m8wind.svg"), plot = w8, height = 5, width = 7)


ggsave(file = here("figures/m8tempRockfalls.svg"), plot = t8_combined, height = 5, width = 7)
ggsave(file = here("figures/m8precipitationRockfalls.svg"), plot = p8_combined, height = 5, width = 7)
ggsave(file = here("figures/m8precipitationIntensityRockfalls.svg"), plot = pi8_combined, height = 5, width = 7)
ggsave(file = here("figures/m8irradianceRockfalls.svg"), plot = irr8_combined, height = 5, width = 7)
ggsave(file = here("figures/m8insolationRockfalls.svg"), plot = insol8_combined, height = 5, width = 7)
ggsave(file = here("figures/m8windRockfalls.svg"), plot = wind8_combined, height = 5, width = 7)



comb <- (t8_combined + p8_combined) / (pi8_combined + wind8_combined) / (irr8_combined + insol8_combined) + 
  plot_layout( guides = 'auto') &  
  theme(
    plot.margin = margin(0, 0, 30, 30)  # Increase space between plots
  )
comb

ggsave(file = here("figures/m8comb.png"), plot = comb, height = 12, width = 14)


```


